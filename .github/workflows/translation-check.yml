name: Check Missing Translations

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - dev

jobs:
  check-translations:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important: get full git history
      
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable
      
      - name: Check for Missing Translations
        id: check
        run: |
          dart .github/scripts/check_translations.dart > result.json
          echo "results=$(cat result.json)" >> $GITHUB_OUTPUT
          
          if [ "$(cat result.json)" != "{}" ]; then
            echo "has_missing=true" >> $GITHUB_OUTPUT
          else
            echo "has_missing=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Find Contributors for Each Language
        if: steps.check.outputs.has_missing == 'true'
        id: find-contributors
        run: |
          # This finds contributors using git blame
          contributors_json="{"
          
          for file in lib/i18n/app_localization_*.arb; do
            if [ -f "$file" ]; then
              locale=$(basename "$file" .arb | sed 's/app_localization_//')
              
              if [ "$locale" != "en" ]; then
                # Get last 3 people who edited this file
                emails=$(git log --follow --format="%ae" -- "$file" | head -3 | sort -u)
                
                # Convert emails to GitHub usernames
                usernames=""
                for email in $emails; do
                  # Try to find GitHub username from git config
                  username=$(git log --author="$email" --format="%an" | head -1 | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
                  if [ ! -z "$username" ]; then
                    usernames="$usernames$username,"
                  fi
                done
                
                usernames=${usernames%,}  # Remove trailing comma
                contributors_json="$contributors_json\"$locale\":[\"$usernames\"],"
              fi
            fi
          done
          
          contributors_json="${contributors_json%,}}"  # Remove trailing comma and close
          echo "contributors=$contributors_json" >> $GITHUB_OUTPUT
      
      - name: Comment on PR
        if: steps.check.outputs.has_missing == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const results = JSON.parse(`${{ steps.check.outputs.results }}`);
            const fs = require('fs');
            
            let message = '## ğŸŒ Translation Check Results\n\n';
            message += 'This PR introduced changes requiring translations:\n\n';
            
            for (const [locale, data] of Object.entries(results)) {
              message += `### ${locale.toUpperCase()}\n`;
              message += `**Missing Keys:** ${data.missingKeys.length}\n`;
              message += `**Coverage:** ${data.coverage}%\n\n`;
              message += data.missingKeys.slice(0, 10).map(key => `- \`${key}\``).join('\n');
              
              if (data.missingKeys.length > 10) {
                message += `\n... and ${data.missingKeys.length - 10} more`;
              }
              
              message += '\n\n';
              
              // Find contributors using git history
              try {
                const { execSync } = require('child_process');
                const filePath = `lib/i18n/app_localization_${locale}.arb`;
                
                // Get unique contributors from git log
                const gitLog = execSync(
                  `git log --follow --pretty=format:"%ae" -- ${filePath} | head -5 | sort -u`,
                  { encoding: 'utf-8' }
                ).trim();
                
                if (gitLog) {
                  const emails = gitLog.split('\n');
                  const usernames = [];
                  
                  for (const email of emails) {
                    // Try to find GitHub username from commits
                    try {
                      const user = await github.rest.search.users({
                        q: `${email} in:email`
                      });
                      
                      if (user.data.items.length > 0) {
                        usernames.push(user.data.items[0].login);
                      }
                    } catch (e) {
                      console.log(`Could not find user for: ${email}`);
                    }
                  }
                  
                  if (usernames.length > 0) {
                    message += '**Contributors (auto-detected):** ';
                    message += usernames.slice(0, 3).map(u => `@${u}`).join(' ');
                    message += '\n\n';
                  }
                }
              } catch (e) {
                console.log(`Error finding contributors for ${locale}: ${e.message}`);
              }
            }
            
            message += '\n---\n';
            message += 'ğŸ“ Please add translations for these keys at your earliest convenience.';
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
