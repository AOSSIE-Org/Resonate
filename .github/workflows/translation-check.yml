name: Translation notifier (post-merge)

on:
  push:
    branches:
      - main
      - dev

permissions:
  contents: read
  pull-requests: write

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve merged PR number for this commit
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.sha;
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha
            });
            if (!prs.data.length) {
              core.setFailed('No PR associated with this commit');
              return;
            }
            core.setOutput('number', prs.data[0].number);

      - name: Read untranslated.txt (if present)
        id: txt
        run: |
          FILE="untranslated.txt"
          if [ ! -f "$FILE" ]; then
            {
              echo 'list<<EOF'
              echo ''
              echo 'EOF'
            } >> $GITHUB_OUTPUT
            exit 0
          fi
          content="$(cat "$FILE")"
          {
            echo 'list<<EOF'
            echo "$content"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Fetch translator mapping issue body
        id: issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: "488"   # <- change if your canonical issue is different
        with:
          script: |
            const issue_number = Number(process.env.ISSUE_NUMBER);
            const { data } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number
            });
            core.setOutput('body', data.body || '');

      - name: Extract @handles from issue description
        id: handles
        uses: actions/github-script@v7
        with:
          script: |
            // Basic: all @mentions in the issue body
            const body = `${{ steps.issue.outputs.body }}`;
            const tags = [...new Set((body.match(/@\w[\w-]+/g) || []))];
            core.setOutput('handles', tags.join(' '));

      - name: Build PR comment body
        id: comment
        run: |
          {
            echo 'body<<EOF'
            echo 'ðŸ”” Translation check'
            echo
            echo 'The following keys/files are listed in lib/i18n/untranslated.txt:'
            if [ -n "${{ steps.txt.outputs.list }}" ]; then
              echo "${{ steps.txt.outputs.list }}"
            else
              echo '- No entries found'
            fi
            echo
            echo "Notifying: ${{ steps.handles.outputs.handles }}"
            echo
            echo '_Automated post-merge notice_'
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Post comment to merged PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: Number('${{ steps.pr.outputs.number }}'),
              body: `${{ steps.comment.outputs.body }}`
            });
