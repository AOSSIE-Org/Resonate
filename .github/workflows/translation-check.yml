name: Translation notifier (post-merge)

on:
  push:
    branches:
      - main
      - dev

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Resolve merged PR number for this commit
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = context.sha;
            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: commitSha
            });
            if (!prs.data.length) {
              core.setFailed('No PR associated with this commit');
              return;
            }
            core.setOutput('number', prs.data[0].number);

      - name: Read untranslated.txt (if present)
        id: txt
        run: |
          FILE="untranslated.txt"
          if [ ! -f "$FILE" ]; then
            {
              echo 'list<<EOF'
              echo ''
              echo 'EOF'
            } >> $GITHUB_OUTPUT
            exit 0
          fi
          content="$(cat "$FILE")"
          {
            echo 'list<<EOF'
            echo "$content"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Fetch translator mapping issue body
        id: issue
        uses: actions/github-script@v7
        env:
          ISSUE_NUMBER: "488"  # Replace with your issue number
        with:
          script: |
            const issue_number = Number(process.env.ISSUE_NUMBER);
            const { data } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number
            });
            core.setOutput('body', data.body || '');

      - name: Map languages to maintainers (Dynamic)
        id: mapping
        uses: actions/github-script@v7
        env:
          LANGUAGES: ${{ steps.txt.outputs.list }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
        with:
          script: |
            const body = process.env.ISSUE_BODY || '';
            const langJson = process.env.LANGUAGES || '{}';
            
            // Parse JSON keys from untranslated.txt
            let untranslatedKeys = [];
            try {
              const parsed = JSON.parse(langJson);
              untranslatedKeys = Object.keys(parsed).map(k => k.toLowerCase());
            } catch(e) {
              console.log("Failed to parse untranslated.txt JSON, fallback to lines");
              untranslatedKeys = langJson.split(/\r?\n/).map(l => l.trim().toLowerCase()).filter(Boolean);
            }

            const langToHandles = {};

            // Parse "- Language by @user" or table rows "| Language | @user |"
            const listRegex = /([\w\s]+)\s+by\s+(.+)/gi;
            const tableRegex = /\|\s*([\w\s]+)\s*\|\s*(.+)\s*\|/gi;

            let match;
            while ((match = listRegex.exec(body)) !== null) {
              const lang = match[1].trim().toLowerCase();
              const handles = match[2].trim().split(/\s+/);
              langToHandles[lang] = handles;
              langToHandles[lang.slice(0,2)] = handles; // map 2-letter code
            }

            while ((match = tableRegex.exec(body)) !== null) {
              const lang = match[1].trim().toLowerCase();
              const handles = match[2].trim().split(/\s+/);
              langToHandles[lang] = handles;
              langToHandles[lang.slice(0,2)] = handles; // map 2-letter code
            }

            // Build output mapping of language -> handles
            const output = [];
            for (const code of untranslatedKeys) {
              const handles = langToHandles[code];
              if (handles) {
                const langName = Object.keys(langToHandles).find(k => k.slice(0,2)===code) || code;
                output.push(`${langName}: ${handles.join(' ')}`);
              }
            }

            core.setOutput('handles', output.join('\n'));

      - name: Build PR comment body
        id: comment
        run: |
          {
            echo 'body<<EOF'
            echo 'ðŸ”” **Translation Check Notice**'
            echo
            echo 'The following untranslated language codes were found in `untranslated.txt`:'
            if [ -n "${{ steps.txt.outputs.list }}" ]; then
              echo '```'
              echo "${{ steps.txt.outputs.list }}"
              echo '```'
            else
              echo '- No entries found'
            fi
            echo
            echo "ðŸ“£ Notifying maintainers per language:"
            echo "${{ steps.mapping.outputs.handles }}"
            echo
            echo '_Automated post-merge notice by Translation Notifier_'
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Post comment to merged PR
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          COMMENT_BODY: ${{ steps.comment.outputs.body }}
        with:
          script: |
            const issueNumber = Number(process.env.PR_NUMBER || 1);
            const body = process.env.COMMENT_BODY || 'No comment generated.';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body
            });